#pragma once

#include "NGMP_include.h"
#include "NetworkMesh.h"
#include "../RankPointValue.h"
#include "../GameSpy/PersistentStorageThread.h"

class PSPlayerStats;

struct GlobalStats
{
	PerGeneralMap wins;
	PerGeneralMap matches;
};

enum class EStatsRequestPolicy
{
	CACHED_ONLY,
	RESPECT_CACHE_ALLOW_REQUEST,
	BYPASS_CACHE_FORCE_REQUEST
};

// NOTE: Must match service indexes
enum class EStatIndex : uint16_t
{
	WINS_PER_GENERAL_0,
	WINS_PER_GENERAL_1,
	WINS_PER_GENERAL_2,
	WINS_PER_GENERAL_3,
	WINS_PER_GENERAL_4,
	WINS_PER_GENERAL_5,
	WINS_PER_GENERAL_6,
	WINS_PER_GENERAL_7,
	WINS_PER_GENERAL_8,
	WINS_PER_GENERAL_9,
	WINS_PER_GENERAL_10,
	WINS_PER_GENERAL_11,
	WINS_PER_GENERAL_12,
	WINS_PER_GENERAL_13,
	WINS_PER_GENERAL_14,

	LOSSES_PER_GENERAL_0,
	LOSSES_PER_GENERAL_1,
	LOSSES_PER_GENERAL_2,
	LOSSES_PER_GENERAL_3,
	LOSSES_PER_GENERAL_4,
	LOSSES_PER_GENERAL_5,
	LOSSES_PER_GENERAL_6,
	LOSSES_PER_GENERAL_7,
	LOSSES_PER_GENERAL_8,
	LOSSES_PER_GENERAL_9,
	LOSSES_PER_GENERAL_10,
	LOSSES_PER_GENERAL_11,
	LOSSES_PER_GENERAL_12,
	LOSSES_PER_GENERAL_13,
	LOSSES_PER_GENERAL_14,

	GAMES_PER_GENERAL_0,
	GAMES_PER_GENERAL_1,
	GAMES_PER_GENERAL_2,
	GAMES_PER_GENERAL_3,
	GAMES_PER_GENERAL_4,
	GAMES_PER_GENERAL_5,
	GAMES_PER_GENERAL_6,
	GAMES_PER_GENERAL_7,
	GAMES_PER_GENERAL_8,
	GAMES_PER_GENERAL_9,
	GAMES_PER_GENERAL_10,
	GAMES_PER_GENERAL_11,
	GAMES_PER_GENERAL_12,
	GAMES_PER_GENERAL_13,
	GAMES_PER_GENERAL_14,

	DURATION_PER_GENERAL_0,
	DURATION_PER_GENERAL_1,
	DURATION_PER_GENERAL_2,
	DURATION_PER_GENERAL_3,
	DURATION_PER_GENERAL_4,
	DURATION_PER_GENERAL_5,
	DURATION_PER_GENERAL_6,
	DURATION_PER_GENERAL_7,
	DURATION_PER_GENERAL_8,
	DURATION_PER_GENERAL_9,
	DURATION_PER_GENERAL_10,
	DURATION_PER_GENERAL_11,
	DURATION_PER_GENERAL_12,
	DURATION_PER_GENERAL_13,
	DURATION_PER_GENERAL_14,

	UNITSKILLED_PER_GENERAL_0,
	UNITSKILLED_PER_GENERAL_1,
	UNITSKILLED_PER_GENERAL_2,
	UNITSKILLED_PER_GENERAL_3,
	UNITSKILLED_PER_GENERAL_4,
	UNITSKILLED_PER_GENERAL_5,
	UNITSKILLED_PER_GENERAL_6,
	UNITSKILLED_PER_GENERAL_7,
	UNITSKILLED_PER_GENERAL_8,
	UNITSKILLED_PER_GENERAL_9,
	UNITSKILLED_PER_GENERAL_10,
	UNITSKILLED_PER_GENERAL_11,
	UNITSKILLED_PER_GENERAL_12,
	UNITSKILLED_PER_GENERAL_13,
	UNITSKILLED_PER_GENERAL_14,

	UNITSLOST_PER_GENERAL_0,
	UNITSLOST_PER_GENERAL_1,
	UNITSLOST_PER_GENERAL_2,
	UNITSLOST_PER_GENERAL_3,
	UNITSLOST_PER_GENERAL_4,
	UNITSLOST_PER_GENERAL_5,
	UNITSLOST_PER_GENERAL_6,
	UNITSLOST_PER_GENERAL_7,
	UNITSLOST_PER_GENERAL_8,
	UNITSLOST_PER_GENERAL_9,
	UNITSLOST_PER_GENERAL_10,
	UNITSLOST_PER_GENERAL_11,
	UNITSLOST_PER_GENERAL_12,
	UNITSLOST_PER_GENERAL_13,
	UNITSLOST_PER_GENERAL_14,

	UNITSBUILT_PER_GENERAL_0,
	UNITSBUILT_PER_GENERAL_1,
	UNITSBUILT_PER_GENERAL_2,
	UNITSBUILT_PER_GENERAL_3,
	UNITSBUILT_PER_GENERAL_4,
	UNITSBUILT_PER_GENERAL_5,
	UNITSBUILT_PER_GENERAL_6,
	UNITSBUILT_PER_GENERAL_7,
	UNITSBUILT_PER_GENERAL_8,
	UNITSBUILT_PER_GENERAL_9,
	UNITSBUILT_PER_GENERAL_10,
	UNITSBUILT_PER_GENERAL_11,
	UNITSBUILT_PER_GENERAL_12,
	UNITSBUILT_PER_GENERAL_13,
	UNITSBUILT_PER_GENERAL_14,

	BUILDINGSKILLED_PER_GENERAL_0,
	BUILDINGSKILLED_PER_GENERAL_1,
	BUILDINGSKILLED_PER_GENERAL_2,
	BUILDINGSKILLED_PER_GENERAL_3,
	BUILDINGSKILLED_PER_GENERAL_4,
	BUILDINGSKILLED_PER_GENERAL_5,
	BUILDINGSKILLED_PER_GENERAL_6,
	BUILDINGSKILLED_PER_GENERAL_7,
	BUILDINGSKILLED_PER_GENERAL_8,
	BUILDINGSKILLED_PER_GENERAL_9,
	BUILDINGSKILLED_PER_GENERAL_10,
	BUILDINGSKILLED_PER_GENERAL_11,
	BUILDINGSKILLED_PER_GENERAL_12,
	BUILDINGSKILLED_PER_GENERAL_13,
	BUILDINGSKILLED_PER_GENERAL_14,

	BUILDINGSLOST_PER_GENERAL_0,
	BUILDINGSLOST_PER_GENERAL_1,
	BUILDINGSLOST_PER_GENERAL_2,
	BUILDINGSLOST_PER_GENERAL_3,
	BUILDINGSLOST_PER_GENERAL_4,
	BUILDINGSLOST_PER_GENERAL_5,
	BUILDINGSLOST_PER_GENERAL_6,
	BUILDINGSLOST_PER_GENERAL_7,
	BUILDINGSLOST_PER_GENERAL_8,
	BUILDINGSLOST_PER_GENERAL_9,
	BUILDINGSLOST_PER_GENERAL_10,
	BUILDINGSLOST_PER_GENERAL_11,
	BUILDINGSLOST_PER_GENERAL_12,
	BUILDINGSLOST_PER_GENERAL_13,
	BUILDINGSLOST_PER_GENERAL_14,

	BUILDINGSBUILT_PER_GENERAL_0,
	BUILDINGSBUILT_PER_GENERAL_1,
	BUILDINGSBUILT_PER_GENERAL_2,
	BUILDINGSBUILT_PER_GENERAL_3,
	BUILDINGSBUILT_PER_GENERAL_4,
	BUILDINGSBUILT_PER_GENERAL_5,
	BUILDINGSBUILT_PER_GENERAL_6,
	BUILDINGSBUILT_PER_GENERAL_7,
	BUILDINGSBUILT_PER_GENERAL_8,
	BUILDINGSBUILT_PER_GENERAL_9,
	BUILDINGSBUILT_PER_GENERAL_10,
	BUILDINGSBUILT_PER_GENERAL_11,
	BUILDINGSBUILT_PER_GENERAL_12,
	BUILDINGSBUILT_PER_GENERAL_13,
	BUILDINGSBUILT_PER_GENERAL_14,

	EARNINGS_PER_GENERAL_0,
	EARNINGS_PER_GENERAL_1,
	EARNINGS_PER_GENERAL_2,
	EARNINGS_PER_GENERAL_3,
	EARNINGS_PER_GENERAL_4,
	EARNINGS_PER_GENERAL_5,
	EARNINGS_PER_GENERAL_6,
	EARNINGS_PER_GENERAL_7,
	EARNINGS_PER_GENERAL_8,
	EARNINGS_PER_GENERAL_9,
	EARNINGS_PER_GENERAL_10,
	EARNINGS_PER_GENERAL_11,
	EARNINGS_PER_GENERAL_12,
	EARNINGS_PER_GENERAL_13,
	EARNINGS_PER_GENERAL_14,

	TECHCAPTURED_PER_GENERAL_0,
	TECHCAPTURED_PER_GENERAL_1,
	TECHCAPTURED_PER_GENERAL_2,
	TECHCAPTURED_PER_GENERAL_3,
	TECHCAPTURED_PER_GENERAL_4,
	TECHCAPTURED_PER_GENERAL_5,
	TECHCAPTURED_PER_GENERAL_6,
	TECHCAPTURED_PER_GENERAL_7,
	TECHCAPTURED_PER_GENERAL_8,
	TECHCAPTURED_PER_GENERAL_9,
	TECHCAPTURED_PER_GENERAL_10,
	TECHCAPTURED_PER_GENERAL_11,
	TECHCAPTURED_PER_GENERAL_12,
	TECHCAPTURED_PER_GENERAL_13,
	TECHCAPTURED_PER_GENERAL_14,

	DISCONS_PER_GENERAL_0,
	DISCONS_PER_GENERAL_1,
	DISCONS_PER_GENERAL_2,
	DISCONS_PER_GENERAL_3,
	DISCONS_PER_GENERAL_4,
	DISCONS_PER_GENERAL_5,
	DISCONS_PER_GENERAL_6,
	DISCONS_PER_GENERAL_7,
	DISCONS_PER_GENERAL_8,
	DISCONS_PER_GENERAL_9,
	DISCONS_PER_GENERAL_10,
	DISCONS_PER_GENERAL_11,
	DISCONS_PER_GENERAL_12,
	DISCONS_PER_GENERAL_13,
	DISCONS_PER_GENERAL_14,

	DESYNCS_PER_GENERAL_0,
	DESYNCS_PER_GENERAL_1,
	DESYNCS_PER_GENERAL_2,
	DESYNCS_PER_GENERAL_3,
	DESYNCS_PER_GENERAL_4,
	DESYNCS_PER_GENERAL_5,
	DESYNCS_PER_GENERAL_6,
	DESYNCS_PER_GENERAL_7,
	DESYNCS_PER_GENERAL_8,
	DESYNCS_PER_GENERAL_9,
	DESYNCS_PER_GENERAL_10,
	DESYNCS_PER_GENERAL_11,
	DESYNCS_PER_GENERAL_12,
	DESYNCS_PER_GENERAL_13,
	DESYNCS_PER_GENERAL_14,

	SURRENDERS_PER_GENERAL_0,
	SURRENDERS_PER_GENERAL_1,
	SURRENDERS_PER_GENERAL_2,
	SURRENDERS_PER_GENERAL_3,
	SURRENDERS_PER_GENERAL_4,
	SURRENDERS_PER_GENERAL_5,
	SURRENDERS_PER_GENERAL_6,
	SURRENDERS_PER_GENERAL_7,
	SURRENDERS_PER_GENERAL_8,
	SURRENDERS_PER_GENERAL_9,
	SURRENDERS_PER_GENERAL_10,
	SURRENDERS_PER_GENERAL_11,
	SURRENDERS_PER_GENERAL_12,
	SURRENDERS_PER_GENERAL_13,
	SURRENDERS_PER_GENERAL_14,

	GAMESOF2P_PER_GENERAL_0,
	GAMESOF2P_PER_GENERAL_1,
	GAMESOF2P_PER_GENERAL_2,
	GAMESOF2P_PER_GENERAL_3,
	GAMESOF2P_PER_GENERAL_4,
	GAMESOF2P_PER_GENERAL_5,
	GAMESOF2P_PER_GENERAL_6,
	GAMESOF2P_PER_GENERAL_7,
	GAMESOF2P_PER_GENERAL_8,
	GAMESOF2P_PER_GENERAL_9,
	GAMESOF2P_PER_GENERAL_10,
	GAMESOF2P_PER_GENERAL_11,
	GAMESOF2P_PER_GENERAL_12,
	GAMESOF2P_PER_GENERAL_13,
	GAMESOF2P_PER_GENERAL_14,

	GAMESOF3P_PER_GENERAL_0,
	GAMESOF3P_PER_GENERAL_1,
	GAMESOF3P_PER_GENERAL_2,
	GAMESOF3P_PER_GENERAL_3,
	GAMESOF3P_PER_GENERAL_4,
	GAMESOF3P_PER_GENERAL_5,
	GAMESOF3P_PER_GENERAL_6,
	GAMESOF3P_PER_GENERAL_7,
	GAMESOF3P_PER_GENERAL_8,
	GAMESOF3P_PER_GENERAL_9,
	GAMESOF3P_PER_GENERAL_10,
	GAMESOF3P_PER_GENERAL_11,
	GAMESOF3P_PER_GENERAL_12,
	GAMESOF3P_PER_GENERAL_13,
	GAMESOF3P_PER_GENERAL_14,

	GAMESOF4P_PER_GENERAL_0,
	GAMESOF4P_PER_GENERAL_1,
	GAMESOF4P_PER_GENERAL_2,
	GAMESOF4P_PER_GENERAL_3,
	GAMESOF4P_PER_GENERAL_4,
	GAMESOF4P_PER_GENERAL_5,
	GAMESOF4P_PER_GENERAL_6,
	GAMESOF4P_PER_GENERAL_7,
	GAMESOF4P_PER_GENERAL_8,
	GAMESOF4P_PER_GENERAL_9,
	GAMESOF4P_PER_GENERAL_10,
	GAMESOF4P_PER_GENERAL_11,
	GAMESOF4P_PER_GENERAL_12,
	GAMESOF4P_PER_GENERAL_13,
	GAMESOF4P_PER_GENERAL_14,

	GAMESOF5P_PER_GENERAL_0,
	GAMESOF5P_PER_GENERAL_1,
	GAMESOF5P_PER_GENERAL_2,
	GAMESOF5P_PER_GENERAL_3,
	GAMESOF5P_PER_GENERAL_4,
	GAMESOF5P_PER_GENERAL_5,
	GAMESOF5P_PER_GENERAL_6,
	GAMESOF5P_PER_GENERAL_7,
	GAMESOF5P_PER_GENERAL_8,
	GAMESOF5P_PER_GENERAL_9,
	GAMESOF5P_PER_GENERAL_10,
	GAMESOF5P_PER_GENERAL_11,
	GAMESOF5P_PER_GENERAL_12,
	GAMESOF5P_PER_GENERAL_13,
	GAMESOF5P_PER_GENERAL_14,

	GAMESOF6P_PER_GENERAL_0,
	GAMESOF6P_PER_GENERAL_1,
	GAMESOF6P_PER_GENERAL_2,
	GAMESOF6P_PER_GENERAL_3,
	GAMESOF6P_PER_GENERAL_4,
	GAMESOF6P_PER_GENERAL_5,
	GAMESOF6P_PER_GENERAL_6,
	GAMESOF6P_PER_GENERAL_7,
	GAMESOF6P_PER_GENERAL_8,
	GAMESOF6P_PER_GENERAL_9,
	GAMESOF6P_PER_GENERAL_10,
	GAMESOF6P_PER_GENERAL_11,
	GAMESOF6P_PER_GENERAL_12,
	GAMESOF6P_PER_GENERAL_13,
	GAMESOF6P_PER_GENERAL_14,

	GAMESOF7P_PER_GENERAL_0,
	GAMESOF7P_PER_GENERAL_1,
	GAMESOF7P_PER_GENERAL_2,
	GAMESOF7P_PER_GENERAL_3,
	GAMESOF7P_PER_GENERAL_4,
	GAMESOF7P_PER_GENERAL_5,
	GAMESOF7P_PER_GENERAL_6,
	GAMESOF7P_PER_GENERAL_7,
	GAMESOF7P_PER_GENERAL_8,
	GAMESOF7P_PER_GENERAL_9,
	GAMESOF7P_PER_GENERAL_10,
	GAMESOF7P_PER_GENERAL_11,
	GAMESOF7P_PER_GENERAL_12,
	GAMESOF7P_PER_GENERAL_13,
	GAMESOF7P_PER_GENERAL_14,

	GAMESOF8P_PER_GENERAL_0,
	GAMESOF8P_PER_GENERAL_1,
	GAMESOF8P_PER_GENERAL_2,
	GAMESOF8P_PER_GENERAL_3,
	GAMESOF8P_PER_GENERAL_4,
	GAMESOF8P_PER_GENERAL_5,
	GAMESOF8P_PER_GENERAL_6,
	GAMESOF8P_PER_GENERAL_7,
	GAMESOF8P_PER_GENERAL_8,
	GAMESOF8P_PER_GENERAL_9,
	GAMESOF8P_PER_GENERAL_10,
	GAMESOF8P_PER_GENERAL_11,
	GAMESOF8P_PER_GENERAL_12,
	GAMESOF8P_PER_GENERAL_13,
	GAMESOF8P_PER_GENERAL_14,

	CUSTOMGAMES_PER_GENERAL_0,
	CUSTOMGAMES_PER_GENERAL_1,
	CUSTOMGAMES_PER_GENERAL_2,
	CUSTOMGAMES_PER_GENERAL_3,
	CUSTOMGAMES_PER_GENERAL_4,
	CUSTOMGAMES_PER_GENERAL_5,
	CUSTOMGAMES_PER_GENERAL_6,
	CUSTOMGAMES_PER_GENERAL_7,
	CUSTOMGAMES_PER_GENERAL_8,
	CUSTOMGAMES_PER_GENERAL_9,
	CUSTOMGAMES_PER_GENERAL_10,
	CUSTOMGAMES_PER_GENERAL_11,
	CUSTOMGAMES_PER_GENERAL_12,
	CUSTOMGAMES_PER_GENERAL_13,
	CUSTOMGAMES_PER_GENERAL_14,

	QUICKMATCHES_PER_GENERAL_0,
	QUICKMATCHES_PER_GENERAL_1,
	QUICKMATCHES_PER_GENERAL_2,
	QUICKMATCHES_PER_GENERAL_3,
	QUICKMATCHES_PER_GENERAL_4,
	QUICKMATCHES_PER_GENERAL_5,
	QUICKMATCHES_PER_GENERAL_6,
	QUICKMATCHES_PER_GENERAL_7,
	QUICKMATCHES_PER_GENERAL_8,
	QUICKMATCHES_PER_GENERAL_9,
	QUICKMATCHES_PER_GENERAL_10,
	QUICKMATCHES_PER_GENERAL_11,
	QUICKMATCHES_PER_GENERAL_12,
	QUICKMATCHES_PER_GENERAL_13,
	QUICKMATCHES_PER_GENERAL_14,

	LOCALE,
	GAMES_AS_RANDOM,
	OPTIONS,
	SYSTEM_SPEC,
	LASTFPS,
	LASTGENERAL,
	GAMESINROWWITHLASTGENERAL,
	CHALLENGEMEDALS,
	BATTLEHONORS,
	QMWINSINAROW,
	MAXQMWINSINAROW,
	WINSINAROW,
	MAXWINSINAROW,
	LOSSESINAROW,
	MAXLOSSESINAROW,
	DISCONSINAROW,

	MAXDISCONSINAROW,
	DESYNCSINAROW,
	MAXDESYNCSINAROW,
	BUILTPARTICLECANNON,
	BUILTNUKE,
	BUILTSCUD,
	LASTLADDERPORT,
	LASTLADDERHOST
};

class NGMP_OnlineServices_StatsInterface
{
public:
	NGMP_OnlineServices_StatsInterface();

	void GetGlobalStats(std::function<void(GlobalStats)> cb);

	Int getPointsForRank(Int rank)
	{
		std::map<int, int> mapRankToXP =
		{
			{RANK_PRIVATE, 0},
			{RANK_CORPORAL, 5},
			{RANK_SERGEANT, 10},
			{RANK_LIEUTENANT, 20},
			{RANK_CAPTAIN, 50},
			{RANK_MAJOR, 100},
			{RANK_COLONEL, 2000},
			{RANK_BRIGADIER_GENERAL, 500},
			{RANK_GENERAL, 1000},
			{RANK_COMMANDER_IN_CHIEF, 2000}
		};

		if (rank < mapRankToXP.size())
		{
			return mapRankToXP[rank];
		}

		return 999999;
	}

	void findPlayerStatsByID(int64_t userID, std::function<void(bool, PSPlayerStats)> cb, EStatsRequestPolicy requestPolicy);

	void UpdateMyStats(PSPlayerStats stats);

private:
	std::string JSONSerialize(PSPlayerStats stats);

private:
	// TODO_NGMP_STATS: Refresh this occasionally
	//PSPlayerStats m_CachedLocalPlayerStats;

	std::map<int64_t, int64_t> m_mapStatsLastRefresh;
	std::map<int64_t, PSPlayerStats> m_mapCachedStats;
	const static int64_t m_cacheTTL = 300000; // 5 minutes
};